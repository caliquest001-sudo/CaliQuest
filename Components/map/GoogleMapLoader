import { useEffect, useState } from 'react';

let googleMapsPromise = null;
let isLoaded = false;

/**
 * Loads Google Maps JavaScript SDK dynamically and securely
 * API key should be provided through environment variable or app config
 */
export function useGoogleMapsLoader(apiKey) {
  const [isMapLoaded, setIsMapLoaded] = useState(isLoaded);
  const [error, setError] = useState(null);

  useEffect(() => {
    if (isLoaded) {
      setIsMapLoaded(true);
      return;
    }

    if (!apiKey) {
      setError('Google Maps API key is not configured');
      return;
    }

    if (!googleMapsPromise) {
      googleMapsPromise = new Promise((resolve, reject) => {
        // Check if already loaded
        if (window.google && window.google.maps) {
          isLoaded = true;
          resolve(window.google);
          return;
        }

        // Create script element
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,geometry`;
        script.async = true;
        script.defer = true;

        script.onload = () => {
          isLoaded = true;
          resolve(window.google);
        };

        script.onerror = () => {
          googleMapsPromise = null;
          reject(new Error('Failed to load Google Maps'));
        };

        document.head.appendChild(script);
      });
    }

    googleMapsPromise
      .then(() => {
        setIsMapLoaded(true);
      })
      .catch((err) => {
        setError(err.message);
      });
  }, [apiKey]);

  return { isMapLoaded, error };
}

export function getGoogleMaps() {
  return window.google?.maps || null;
}