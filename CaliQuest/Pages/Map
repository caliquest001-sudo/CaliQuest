import React, { useState, useMemo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { MapPin, Dumbbell, Star, X, Filter } from 'lucide-react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";
import MapContainer from '@/components/map/MapContainer';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

/**
 * Map Page - Full-screen Google Maps integration
 * 
 * Features:
 * - Shows workout parks on the map
 * - Filters by equipment type
 * - Displays park details on marker click
 * - User geolocation
 * - Responsive design
 */
export default function MapPage() {
  const [selectedPark, setSelectedPark] = useState(null);
  const [equipmentFilter, setEquipmentFilter] = useState('all');

  // Get API key from Base44 secrets
  const GOOGLE_MAPS_API_KEY = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;

  // Fetch parks
  const { data: parks, isLoading } = useQuery({
    queryKey: ['parks'],
    queryFn: () => base44.entities.Park.list('-created_date', 100)
  });

  // Filter parks by equipment
  const filteredParks = useMemo(() => {
    if (!parks) return [];
    if (equipmentFilter === 'all') return parks;
    
    return parks.filter(park => 
      park.equipment_available?.some(eq => 
        eq.toLowerCase().includes(equipmentFilter.toLowerCase())
      )
    );
  }, [parks, equipmentFilter]);

  // Get unique equipment types for filter
  const equipmentTypes = useMemo(() => {
    if (!parks) return [];
    const types = new Set();
    parks.forEach(park => {
      park.equipment_available?.forEach(eq => types.add(eq));
    });
    return Array.from(types).sort();
  }, [parks]);

  // Convert parks to map markers
  const markers = useMemo(() => {
    return filteredParks
      .filter(park => park.latitude && park.longitude)
      .map(park => ({
        id: park.id,
        position: {
          lat: park.latitude,
          lng: park.longitude
        },
        title: park.name,
        content: `
          <div style="padding: 8px; max-width: 250px;">
            <h3 style="font-weight: 600; font-size: 16px; margin-bottom: 4px; color: #18181b;">
              ${park.name}
            </h3>
            <p style="font-size: 12px; color: #71717a; margin-bottom: 8px;">
              <span style="margin-right: 4px;">üìç</span>
              ${park.location}
            </p>
            ${park.bonus_multiplier ? `
              <div style="display: inline-flex; align-items: center; gap: 4px; background: #84cc16; 
                          color: #18181b; padding: 4px 8px; border-radius: 12px; font-size: 11px; 
                          font-weight: 600; margin-bottom: 8px;">
                <span>‚≠ê</span>
                +${Math.round((park.bonus_multiplier - 1) * 100)}% XP
              </div>
            ` : ''}
            ${park.description ? `
              <p style="font-size: 13px; color: #3f3f46; margin: 8px 0;">
                ${park.description}
              </p>
            ` : ''}
            ${park.equipment_available?.length > 0 ? `
              <div style="margin-top: 8px;">
                <p style="font-size: 11px; color: #71717a; font-weight: 500; margin-bottom: 4px;">
                  Equipment:
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${park.equipment_available.map(eq => `
                    <span style="background: #f4f4f5; color: #3f3f46; padding: 2px 8px; 
                                 border-radius: 8px; font-size: 11px;">
                      ${eq}
                    </span>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `,
        park: park
      }));
  }, [filteredParks]);

  // Calculate center based on parks or use default
  const mapCenter = useMemo(() => {
    if (!markers.length) {
      return { lat: 40.7128, lng: -74.0060 }; // NYC default
    }
    
    // Calculate average center of all parks
    const avgLat = markers.reduce((sum, m) => sum + m.position.lat, 0) / markers.length;
    const avgLng = markers.reduce((sum, m) => sum + m.position.lng, 0) / markers.length;
    
    return { lat: avgLat, lng: avgLng };
  }, [markers]);

  const handleMarkerClick = (markerData) => {
    setSelectedPark(markerData.park);
  };

  return (
    <div className="relative h-screen w-screen overflow-hidden bg-zinc-950">
      {/* Map */}
      <MapContainer
        apiKey={GOOGLE_MAPS_API_KEY}
        defaultCenter={mapCenter}
        defaultZoom={markers.length > 0 ? 12 : 11}
        markers={markers}
        onMarkerClick={handleMarkerClick}
        className="w-full h-full"
      />

      {/* Top controls */}
      <div className="absolute top-4 left-4 right-20 z-10">
        <div className="bg-white rounded-2xl shadow-xl p-4 backdrop-blur-sm bg-white/95">
          <div className="flex items-center gap-3">
            <div className="flex items-center gap-2 flex-1 min-w-0">
              <MapPin className="w-5 h-5 text-lime-500 flex-shrink-0" />
              <div className="min-w-0">
                <h1 className="text-lg font-bold text-zinc-900 truncate">Workout Parks</h1>
                <p className="text-xs text-zinc-500">
                  {filteredParks.length} {filteredParks.length === 1 ? 'location' : 'locations'}
                </p>
              </div>
            </div>

            {/* Equipment filter */}
            {equipmentTypes.length > 0 && (
              <Select value={equipmentFilter} onValueChange={setEquipmentFilter}>
                <SelectTrigger className="w-[140px] h-9 text-xs border-zinc-200">
                  <Filter className="w-3 h-3 mr-1" />
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Equipment</SelectItem>
                  {equipmentTypes.map(type => (
                    <SelectItem key={type} value={type} className="text-xs">
                      {type}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            )}
          </div>
        </div>
      </div>

      {/* Selected park details (mobile-friendly bottom sheet) */}
      <AnimatePresence>
        {selectedPark && (
          <motion.div
            initial={{ y: '100%' }}
            animate={{ y: 0 }}
            exit={{ y: '100%' }}
            transition={{ type: 'spring', damping: 30, stiffness: 300 }}
            className="absolute bottom-0 left-0 right-0 z-20 bg-white rounded-t-3xl shadow-2xl max-h-[70vh] overflow-hidden"
          >
            <div className="p-6 overflow-y-auto max-h-[70vh]">
              {/* Close button */}
              <Button
                variant="ghost"
                size="icon"
                onClick={() => setSelectedPark(null)}
                className="absolute top-4 right-4 rounded-full"
              >
                <X className="w-5 h-5" />
              </Button>

              {/* Park image */}
              {selectedPark.photo_url && (
                <div className="aspect-video rounded-2xl overflow-hidden mb-4 -mx-2">
                  <img 
                    src={selectedPark.photo_url} 
                    alt={selectedPark.name}
                    className="w-full h-full object-cover"
                  />
                </div>
              )}

              {/* Park info */}
              <div className="mb-4">
                <div className="flex items-start justify-between mb-2">
                  <h2 className="text-2xl font-bold text-zinc-900 pr-8">
                    {selectedPark.name}
                  </h2>
                  {selectedPark.bonus_multiplier && (
                    <div className="flex items-center gap-1 px-3 py-1 rounded-full bg-lime-100 flex-shrink-0">
                      <Star className="w-3 h-3 text-lime-600" />
                      <span className="text-lime-700 text-xs font-bold">
                        +{Math.round((selectedPark.bonus_multiplier - 1) * 100)}%
                      </span>
                    </div>
                  )}
                </div>

                <div className="flex items-center gap-2 text-zinc-600 text-sm mb-3">
                  <MapPin className="w-4 h-4" />
                  <span>{selectedPark.location}</span>
                </div>

                {selectedPark.description && (
                  <p className="text-zinc-700 leading-relaxed mb-4">
                    {selectedPark.description}
                  </p>
                )}
              </div>

              {/* Equipment */}
              {selectedPark.equipment_available?.length > 0 && (
                <div className="border-t border-zinc-200 pt-4">
                  <div className="flex items-center gap-2 mb-3">
                    <Dumbbell className="w-4 h-4 text-zinc-500" />
                    <span className="text-sm font-semibold text-zinc-900">Available Equipment</span>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {selectedPark.equipment_available.map((equipment, i) => (
                      <span 
                        key={i}
                        className="px-3 py-1.5 rounded-full bg-zinc-100 text-zinc-700 text-sm"
                      >
                        {equipment}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* Action button */}
              <div className="mt-6 pt-4 border-t border-zinc-200">
                <Button 
                  className="w-full bg-lime-500 hover:bg-lime-600 text-white font-bold py-6 rounded-2xl"
                  onClick={() => {
                    // TODO: Navigate to workout or save as preferred park
                    alert('Start workout at ' + selectedPark.name);
                  }}
                >
                  Start Workout Here
                </Button>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Loading overlay */}
      {isLoading && (
        <div className="absolute inset-0 bg-zinc-950/50 backdrop-blur-sm flex items-center justify-center z-30">
          <div className="bg-white rounded-2xl p-6 shadow-xl">
            <div className="animate-pulse flex items-center gap-3">
              <div className="w-3 h-3 bg-lime-500 rounded-full" />
              <span className="text-zinc-900 font-medium">Loading parks...</span>
            </div>
          </div>
        </div>
      )}
      </div>
      );
      }