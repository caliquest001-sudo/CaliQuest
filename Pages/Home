import React, { useState } from 'react';
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Loader2, ChevronRight, Dumbbell, Target, Zap, ChevronDown, ChevronUp, TrendingUp } from 'lucide-react';
import { format, startOfMonth, endOfMonth, eachDayOfInterval, getDay, startOfWeek, addDays } from 'date-fns';
import ExerciseLogModal from '@/components/home/ExerciseLogModal';

const levelColors = {
  beginner: '#FCF1C3',
  intermediate: '#FC0D0F',
  advanced: '#FF1B4C',
  elite: '#C0C0C0'
};

export default function Home() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [calendarExpanded, setCalendarExpanded] = useState(false);
  const [selectedDate, setSelectedDate] = useState(null);
  const [isLogModalOpen, setIsLogModalOpen] = useState(false);

  const { data: user, isLoading: userLoading } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me()
  });

  const { data: profile, isLoading: profileLoading } = useQuery({
    queryKey: ['userProfile', user?.email],
    queryFn: async () => {
      const profiles = await base44.entities.UserProfile.filter({ user_id: user.email });
      return profiles[0] || null;
    },
    enabled: !!user?.email
  });

  const isLoading = userLoading || profileLoading;

  // Redirect to assessment if not completed
  React.useEffect(() => {
    if (!isLoading && user && (!profile || !profile.assessment_completed)) {
      navigate(createPageUrl('Assessment'));
    }
  }, [isLoading, user, profile, navigate]);

  // Fetch DailyTask for selected date
  const { data: dailyTasksForDate } = useQuery({
    queryKey: ['dailyTasksForDate', user?.email, selectedDate],
    queryFn: async () => {
      if (!selectedDate) return null;
      const tasks = await base44.entities.DailyTask.filter({
        user_id: user.email,
        date: format(selectedDate, 'yyyy-MM-dd')
      });
      return tasks.length > 0 ? tasks : [];
    },
    enabled: !!user?.email && !!selectedDate
  });

  // Fetch exercise log for selected date
  const { data: exerciseLog } = useQuery({
    queryKey: ['exerciseLog', user?.email, selectedDate],
    queryFn: async () => {
      if (!selectedDate) return null;
      const logs = await base44.entities.ExerciseLog.filter({
        user_id: user.email,
        date: format(selectedDate, 'yyyy-MM-dd')
      });
      return logs.length > 0 ? logs[0] : null;
    },
    enabled: !!user?.email && !!selectedDate
  });

  // Save exercise log mutation
  const saveLogMutation = useMutation({
    mutationFn: async (notes) => {
      const dateStr = format(selectedDate, 'yyyy-MM-dd');
      
      if (exerciseLog) {
        return base44.entities.ExerciseLog.update(exerciseLog.id, {
          notes
        });
      } else {
        return base44.entities.ExerciseLog.create({
          user_id: user.email,
          date: dateStr,
          notes
        });
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['exerciseLog']);
      setIsLogModalOpen(false);
    }
  });

  const handleDayClick = (day) => {
    setSelectedDate(day);
    setIsLogModalOpen(true);
  };

  const handleSaveLog = (notes) => {
    saveLogMutation.mutate(notes);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-zinc-950 flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-lime-400" />
      </div>
    );
  }

  const stats = profile?.stats || { workouts_completed: 0, total_exercises: 0, streak_days: 0 };
  const currentLevel = profile?.level || 'beginner';
  const currentExp = profile?.points || 0;
  const levelColor = levelColors[currentLevel];

  // Calculate next level XP requirement
  const levelExpRequirements = {
    beginner: 1000,
    intermediate: 1000,
    advanced: 1000,
    elite: 1000
  };
  const maxExp = levelExpRequirements[currentLevel];

  // Calendar
  const today = new Date();
  const monthStart = startOfMonth(today);
  const monthEnd = endOfMonth(today);
  const daysInMonth = eachDayOfInterval({ start: monthStart, end: monthEnd });
  const startDay = getDay(monthStart);
  
  // Week view
  const weekStart = startOfWeek(today, { weekStartsOn: 1 });
  const weekDays = Array.from({ length: 7 }, (_, i) => addDays(weekStart, i));

  return (
    <div className="min-h-screen bg-zinc-950 pb-24">
      <div className="grid lg:grid-cols-2 gap-6 max-w-7xl mx-auto p-6">
        {/* LEFT COLUMN */}
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-start justify-between">
            <div>
              <p className="text-zinc-400 text-sm mb-1">Welcome back</p>
              <h1 className="text-3xl font-bold text-white flex items-center gap-2">
                Hi {profile?.display_name?.split(' ')[0] || user?.full_name?.split(' ')[0] || 'User'} ðŸ‘‹
              </h1>
            </div>
            <button 
              onClick={() => navigate(createPageUrl('Profile'))}
              className="w-12 h-12 rounded-full bg-zinc-800 border-2 border-zinc-700 flex items-center justify-center text-white font-bold transition-colors"
              style={{ borderColor: 'rgb(63, 63, 70)' }}
              onMouseEnter={(e) => e.currentTarget.style.borderColor = levelColor}
              onMouseLeave={(e) => e.currentTarget.style.borderColor = 'rgb(63, 63, 70)'}
            >
              {(profile?.display_name || user?.full_name || 'U')[0].toUpperCase()}
            </button>
          </div>

          {/* Calendar */}
          <div className="bg-zinc-900 rounded-3xl p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-white font-bold">{format(today, 'MMMM yyyy')}</h3>
              <button 
                onClick={() => setCalendarExpanded(!calendarExpanded)}
                className="text-zinc-400 hover:text-white transition-colors"
              >
                {calendarExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
              </button>
            </div>
            
            <div className="grid grid-cols-7 gap-2">
              {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((day, i) => (
                <div key={i} className="text-center text-zinc-500 text-sm font-medium mb-2">
                  {day}
                </div>
              ))}
              
              {calendarExpanded ? (
                <>
                  {Array.from({ length: startDay === 0 ? 6 : startDay - 1 }).map((_, i) => (
                    <div key={`empty-${i}`} />
                  ))}
                  {daysInMonth.map((day, i) => {
                    const isToday = format(day, 'yyyy-MM-dd') === format(today, 'yyyy-MM-dd');
                    return (
                      <button
                        key={i}
                        onClick={() => handleDayClick(day)}
                        className={`aspect-square rounded-full flex items-center justify-center text-sm font-medium transition-opacity hover:opacity-70 ${
                          isToday 
                            ? 'text-black font-bold' 
                            : 'text-white'
                        }`}
                        style={{ backgroundColor: isToday ? levelColor : 'rgb(39, 39, 42)' }}
                      >
                        {format(day, 'd')}
                      </button>
                    );
                  })}
                </>
              ) : (
                <>
                  {weekDays.map((day, i) => {
                    const isToday = format(day, 'yyyy-MM-dd') === format(today, 'yyyy-MM-dd');
                    return (
                      <button
                        key={i}
                        onClick={() => handleDayClick(day)}
                        className={`aspect-square rounded-full flex items-center justify-center text-sm font-medium transition-opacity hover:opacity-70 ${
                          isToday 
                            ? 'text-black font-bold' 
                            : 'text-white'
                        }`}
                        style={{ backgroundColor: isToday ? levelColor : 'rgb(39, 39, 42)' }}
                      >
                        {format(day, 'd')}
                      </button>
                    );
                  })}
                </>
              )}
            </div>
          </div>

          {/* Find Your Level Card */}
          <div 
            onClick={() => navigate(createPageUrl('Assessment'))}
            className="rounded-3xl p-6 cursor-pointer hover:opacity-90 transition-opacity relative overflow-hidden"
            style={{ backgroundColor: levelColor }}
          >
            <p className="text-zinc-800 text-sm mb-1">Get Started</p>
            <h2 className="text-2xl font-bold text-black mb-2">Find Your Level</h2>
            <p className="text-zinc-800 text-sm mb-4">
              Take a quick assessment to get personalized workouts
            </p>
            <div className="absolute bottom-6 right-6 w-10 h-10 rounded-full bg-black flex items-center justify-center">
              <ChevronRight className="w-5 h-5" style={{ color: levelColor }} />
            </div>
          </div>

          {/* Current Exp */}
          <div>
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-white font-bold">Current Exp</h3>
              <div 
                className="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold"
                style={{ backgroundColor: `${levelColor}20`, color: levelColor }}
              >
                <div className="w-2 h-2 rounded-full" style={{ backgroundColor: levelColor }} />
                {currentLevel.charAt(0).toUpperCase() + currentLevel.slice(1)}
              </div>
            </div>
            <div className="flex items-baseline gap-2 mb-2">
              <span className="text-4xl font-bold text-white">{currentExp}</span>
              <span className="text-zinc-500 text-lg">/ {maxExp} XP</span>
            </div>

            {/* EXP Bar */}
            <div className="w-full h-3 bg-zinc-800 rounded-full overflow-hidden mb-2">
              <div 
                className="h-full transition-all duration-500"
                style={{ 
                  width: `${Math.min((currentExp / maxExp) * 100, 100)}%`,
                  backgroundColor: levelColor
                }}
              />
            </div>

            <p className="text-zinc-500 text-sm">{maxExp - currentExp} XP to next level</p>
            </div>
        </div>

        {/* RIGHT COLUMN */}
        <div className="space-y-6">
          {/* Stats */}
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-zinc-900 rounded-3xl p-5">
              <p className="text-zinc-400 text-sm mb-1">Streak</p>
              <p className="text-4xl font-bold text-white">{stats.streak_days} days</p>
            </div>
            <div className="bg-zinc-900 rounded-3xl p-5">
              <p className="text-zinc-400 text-sm mb-1">Workouts</p>
              <p className="text-4xl font-bold text-white">{stats.workouts_completed}</p>
            </div>
          </div>

          {/* Your Plan */}
          <div>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-white">Your Plan</h2>
              <button 
                onClick={() => navigate(createPageUrl('Levels'))}
                className="text-zinc-400 text-sm hover:text-white transition-colors"
              >
                See all
              </button>
            </div>

            {/* Action Cards */}
            <div className="space-y-3">
              {/* Daily Quest */}
              <div 
                onClick={() => navigate(createPageUrl('DailyTasks'))}
                className="bg-zinc-900 rounded-3xl p-5 flex items-center gap-4 cursor-pointer hover:bg-zinc-800 transition-colors"
              >
                <div className="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0" style={{ backgroundColor: levelColor }}>
                  <Target className="w-7 h-7 text-black" />
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="text-white font-bold text-lg mb-1">Daily Quest</h3>
                  <p className="text-zinc-400 text-sm">Today's challenges</p>
                </div>
                <div className="text-right flex-shrink-0">
                  <div className="text-white font-bold">+50</div>
                  <div className="text-zinc-500 text-xs">XP</div>
                </div>
              </div>

              {/* Browse Exercises */}
              <div 
                onClick={() => navigate(createPageUrl('BrowseExercises'))}
                className="bg-zinc-900 rounded-3xl p-5 flex items-center gap-4 cursor-pointer hover:bg-zinc-800 transition-colors"
              >
                <div className="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0" style={{ backgroundColor: levelColor }}>
                  <Dumbbell className="w-7 h-7 text-black" />
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="text-white font-bold text-lg mb-1">Browse Exercises</h3>
                  <p className="text-zinc-400 text-sm">All movements</p>
                </div>
                <ChevronRight className="w-6 h-6 text-zinc-600 flex-shrink-0" />
              </div>

              {/* Progress Feed */}
              <div 
                onClick={() => navigate(createPageUrl('Progress'))}
                className="bg-zinc-900 rounded-3xl p-5 flex items-center gap-4 cursor-pointer hover:bg-zinc-800 transition-colors"
              >
                <div className="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0" style={{ backgroundColor: levelColor }}>
                  <Zap className="w-7 h-7 text-black" />
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="text-white font-bold text-lg mb-1">Progress Feed</h3>
                  <p className="text-zinc-400 text-sm">Share your gains</p>
                </div>
                <ChevronRight className="w-6 h-6 text-zinc-600 flex-shrink-0" />
              </div>

              {/* Skill Levels */}
              <div 
                onClick={() => navigate(createPageUrl('Levels'))}
                className="bg-zinc-900 rounded-3xl p-5 flex items-center gap-4 cursor-pointer hover:bg-zinc-800 transition-colors"
              >
                <div className="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0" style={{ backgroundColor: levelColor }}>
                  <TrendingUp className="w-7 h-7 text-black" />
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="text-white font-bold text-lg mb-1">Skill Levels</h3>
                  <p className="text-zinc-400 text-sm">View progression</p>
                </div>
                <ChevronRight className="w-6 h-6 text-zinc-600 flex-shrink-0" />
              </div>

              {/* Leaderboard */}
              <div 
                onClick={() => navigate(createPageUrl('Leaderboard'))}
                className="bg-zinc-900 rounded-3xl p-5 flex items-center gap-4 cursor-pointer hover:bg-zinc-800 transition-colors"
              >
                <div className="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0" style={{ backgroundColor: levelColor }}>
                  <Zap className="w-7 h-7 text-black" />
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="text-white font-bold text-lg mb-1">Leaderboard</h3>
                  <p className="text-zinc-400 text-sm">Compete & rank</p>
                </div>
                <ChevronRight className="w-6 h-6 text-zinc-600 flex-shrink-0" />
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Exercise Log Modal */}
              <ExerciseLogModal
                date={selectedDate}
                isOpen={isLogModalOpen}
                onClose={() => {
                  setIsLogModalOpen(false);
                  setSelectedDate(null);
                }}
                dailyTasks={dailyTasksForDate || []}
                exerciseLog={exerciseLog}
                onSave={handleSaveLog}
                levelColor={levelColor}
              />
    </div>
  );
}   